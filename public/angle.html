<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手机角度与距离变化计算</title>
</head>
<body>
    <h1>手机角度与距离变化计算</h1>
    <p>点击按钮记录两次的传感器数据并计算角度和距离变化。</p>
    <button id="startButton">记录起始数据</button>
    <button id="endButton">计算角度与距离变化</button>
    <p id="result">
        <strong>角度变化：</strong><span id="angleChange">N/A</span><br>
        <strong>距离变化：</strong><span id="distanceChange">N/A</span> 米
    </p>

    <script>
        let initialOrientation = null;
        let velocity = { x: 0, y: 0, z: 0 };
        let position = { x: 0, y: 0, z: 0 };
        let lastTimestamp = null;
        let hasRecordedStart = false;

        const ACCELERATION_THRESHOLD = 0.2; // 加速度噪声阈值，单位 m/s²

        function calculateOrientation(event) {
            const { alpha, beta, gamma } = event;
            return { alpha: alpha || 0, beta: beta || 0, gamma: gamma || 0 };
        }

        function calculateAcceleration(event, deltaTime) {
            const { x = 0, y = 0, z = 0 } = event.acceleration || {};

            // 过滤噪声
            const filteredX = Math.abs(x) > ACCELERATION_THRESHOLD ? x : 0;
            const filteredY = Math.abs(y) > ACCELERATION_THRESHOLD ? y : 0;
            const filteredZ = Math.abs(z) > ACCELERATION_THRESHOLD ? z : 0;

            velocity.x += filteredX * deltaTime;
            velocity.y += filteredY * deltaTime;
            velocity.z += filteredZ * deltaTime;

            position.x += velocity.x * deltaTime;
            position.y += velocity.y * deltaTime;
            position.z += velocity.z * deltaTime;
        }

        // 监听起始数据
        document.getElementById('startButton').addEventListener('click', () => {
            if (!window.DeviceMotionEvent || !window.DeviceOrientationEvent) {
                alert("设备不支持必要的传感器。");
                return;
            }

            velocity = { x: 0, y: 0, z: 0 };
            position = { x: 0, y: 0, z: 0 };
            lastTimestamp = null;

            window.addEventListener('deviceorientation', function captureStart(event) {
                initialOrientation = calculateOrientation(event);
                hasRecordedStart = true; // 标记已记录起始数据
                alert(`起始角度：alpha=${initialOrientation.alpha.toFixed(2)}, beta=${initialOrientation.beta.toFixed(2)}, gamma=${initialOrientation.gamma.toFixed(2)}`);
                window.removeEventListener('deviceorientation', captureStart); // 只记录一次
            });
        });

        // 监听结束数据并计算角度与距离变化
        document.getElementById('endButton').addEventListener('click', () => {
            if (!hasRecordedStart) {
                alert("请先点击记录起始数据。");
                return;
            }

            let finalOrientation = null;

            window.addEventListener('deviceorientation', function captureEnd(event) {
                finalOrientation = calculateOrientation(event);

                // 计算角度变化
                const angleChange = {
                    alpha: Math.abs(finalOrientation.alpha - initialOrientation.alpha),
                    beta: Math.abs(finalOrientation.beta - initialOrientation.beta),
                    gamma: Math.abs(finalOrientation.gamma - initialOrientation.gamma)
                };

                // 假设时间间隔 deltaTime 为上次 devicemotion 更新的时间差
                window.addEventListener('devicemotion', function updateDistance(event) {
                    const deltaTime = lastTimestamp
                        ? (event.timeStamp - lastTimestamp) / 1000 // 秒
                        : 0;
                    lastTimestamp = event.timeStamp;

                    // 更新加速度、速度和位置
                    calculateAcceleration(event, deltaTime);

                    // 计算总位移
                    const distance = Math.sqrt(
                        position.x ** 2 + position.y ** 2 + position.z ** 2
                    );

                    document.getElementById('angleChange').innerText = `
                        α: ${angleChange.alpha.toFixed(2)}, 
                        β: ${angleChange.beta.toFixed(2)}, 
                        γ: ${angleChange.gamma.toFixed(2)}
                    `;
                    document.getElementById('distanceChange').innerText = distance.toFixed(2);

                    window.removeEventListener('devicemotion', updateDistance); // 只记录一次
                });

                window.removeEventListener('deviceorientation', captureEnd); // 只记录一次
            });
        });
    </script>
</body>
</html>
